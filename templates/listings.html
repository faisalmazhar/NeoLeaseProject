{% extends "base.html" %}
{% block title %}Ons Aanbod | Neo Lease{% endblock %}

{% block content %}

<!-- Purple Hero (shorter) -->
<section class="listings-hero">
  <div class="container">
    <h1 style="text-align:left;">Ons aanbod</h1>

    <form action="{{ url_for('listings') }}" method="get"
          style="max-width:800px; margin-top:1rem;">
      
      <div style="margin-bottom:1rem;">
        <input
          type="text"
          name="q"
          placeholder="Bijv. 'GTI' of 'Panoramadak'"
          value="{{ current_q or '' }}"
          style="
            width:100%;
            padding:0.75rem;
            border:1px solid #4c37c6;
            border-radius:4px;
          "
        >
      </div>

      <div style="
      display: flex; 
      flex-wrap: wrap;
      gap: 1rem; 
      margin-bottom:1rem;"
      class="filter-box"
      >
      <select name="brand" id="brandSelect">
        <option value="">Merk</option>
        {% for b in brand_choices %}
          <option value="{{ b }}" {% if b == current_brand %}selected{% endif %}>
            {{ b }}
          </option>
        {% endfor %}
      </select>

      <select name="model" id="modelSelect" disabled>
        <option value="">Model</option>
      </select>
          
        <select name="voertuigsoort">
          <option value="">Voertuigsoort</option>
          {% for t in type_choices %}
            <option value="{{ t }}" {% if t == current_voertuigsoort %}selected{% endif %}>
              {{ t }}
            </option>
          {% endfor %}
        </select>
      
        <select name="brandstof">
          <option value="">Brandstof</option>
          {% for f in fuel_choices %}
            <option value="{{ f }}" {% if f == current_brandstof %}selected{% endif %}>
              {{ f|title }}
            </option>
          {% endfor %}
        </select>

        <select name="btw_marge">
          <option value="">Btw / Marge</option>
          {% for bm in btw_marge_choices %}
            <option value="{{ bm }}"
                    {% if bm == current_btw_marge %}selected{% endif %}>
              {{ bm }}
            </option>
          {% endfor %}
        </select>

        <select name="monthly" >
          <option value="">Budget&nbsp;(p/m)</option>
          <option value="200-300" {% if current_monthly=='200-300' %}selected{% endif %}>€200 – €300</option>
          <option value="301-400" {% if current_monthly=='301-400' %}selected{% endif %}>€301 – €400</option>
          <option value="401-500" {% if current_monthly=='401-500' %}selected{% endif %}>€401 – €500</option>
          <option value="501-600" {% if current_monthly=='501-600' %}selected{% endif %}>€501 – €600</option>
          <option value="601-700" {% if current_monthly=='601-700' %}selected{% endif %}>€601 – €700</option>
          <option value="700+"    {% if current_monthly=='700+'    %}selected{% endif %}>&gt; €700</option>
        </select>

        <select name="sort" >
          <option value="">Sorteren op</option>
          <option value="price_asc" {% if current_sort == 'price_asc' %} selected {% endif %}>Prijs (Laag - Hoog)</option>
          <option value="price_desc" {% if current_sort == 'price_desc' %} selected {% endif %}>Prijs (Hoog - Laag)</option>
        </select>

        <button type="submit"
                style="
                  background:#4c37c6; 
                  color:#fff; 
                  padding:0.6rem 1.2rem; 
                  border:none;
                  border-radius:4px;
                  font-weight:500;
                ">
          Filter
        </button>
        
      </div>
    </form>
  </div>
</section>

<div class="container" style="margin-top:1rem;">
  {% if pagination.total %}
    <p style="margin-bottom:1.5rem; font-weight:500;">
      {{ pagination.total }} resultaten gevonden
    </p>
  {% endif %}
</div>

<section class="container" style="padding-top: 1rem;">
  <div class="car-grid"
       style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
    {% for car in cars %}
      <div class="car-card">
    <a href="{{ url_for('car_detail', car_id=car.id) }}"
       class="thumb-wrapper">
    
      {% if car.images and car.images|length > 0 %}
        {% set urls = car.images|map(attribute='image_url')|join(',') %}
        <img class="listing-thumb"
             data-image-urls="{{ urls }}"
             src="{{ car.images[0].image_url }}"
            loading="lazy" 
          width="300" height="180"
            alt="Car Image">
        <div class="thumb-spinner" style="display:none;"></div>
      {% else %}
      <img class="listing-thumb"
           data-image-urls=""
           src="{{ url_for('static', filename='images/fallback.png') }}"
          loading="lazy" 
        width="300" height="180"
          alt="Geen afbeelding">
      {% endif %}
    </a>

        <h3>
          <a href="{{ url_for('car_detail', car_id=car.id) }}">
            {{ car.title or 'Onbekend' }}
          </a>
        </h3>
        <p style="color:#999; margin-bottom:0.5rem;">
          {{ car.subtitle }}
        </p>
        <p>
          <strong>{{ car.financial_lease_price|euro }}</strong> / {{ car.financial_lease_term }}
        </p>
        <p>
          {{ car.brandstof }} | {{ car.km_stand }} km | {{ car.bouwjaar }}
        </p>
        <p>
          Prijs: {{ car.prijs|euro }}
        </p>
        <a href="{{ url_for('car_detail', car_id=car.id) }}"
           class="btn border"
           style="margin-top:1rem;">
          Meer info
        </a>
      </div>
    {% endfor %}
  </div>

<!-- PAGINATION FOR DESKTOP -->
<div class="d-none d-md-block" style="text-align:center; margin-top:2rem; margin-bottom:3rem;">
  {% set query_args = request.args.to_dict() %}
  
  {% if page > 1 %}
    {% set prev_args = query_args.copy() %}
    {% set _ = prev_args.update({'page': page - 1}) %}
    <a href="{{ url_for('listings', **prev_args) }}">&laquo; Vorige</a>
  {% endif %}

  {% for p in range(start_page, end_page + 1) %}
    {% set page_args = query_args.copy() %}
    {% set _ = page_args.update({'page': p}) %}
    {% if p == page %}
      <span style="display:inline-block;margin:0 0.5rem;padding:0.3rem 0.7rem;border:2px solid #4c37c6;border-radius:50%;font-weight:bold;color:#4c37c6;">
        {{ p }}
      </span>
    {% else %}
      <a href="{{ url_for('listings', **page_args) }}"
         style="display:inline-block;margin:0 0.5rem;padding:0.3rem 0.7rem;text-decoration:none;border:1px solid #ccc;border-radius:50%;color:#000;">
        {{ p }}
      </a>
    {% endif %}
  {% endfor %}

  {% if page < total_pages %}
    {% set next_args = query_args.copy() %}
    {% set _ = next_args.update({'page': page + 1}) %}
    <a href="{{ url_for('listings', **next_args) }}">Volgende &raquo;</a>
  {% endif %}
</div>

<!-- PAGINATION FOR MOBILE -->
<div class="d-md-none" style="text-align:center; margin-top:2rem; margin-bottom:3rem;">
  {% set query_args = request.args.to_dict() %}
  {% set mobile_start = page - 1 %}
  {% if mobile_start < 1 %}{% set mobile_start = 1 %}{% endif %}
  {% set mobile_end = page + 1 %}
  {% if mobile_end > total_pages %}{% set mobile_end = total_pages %}{% endif %}
  {% set mobile_window = mobile_end - mobile_start + 1 %}
  {% if mobile_window < 3 %}
    {% if mobile_start == 1 %}
      {% set mobile_end = [mobile_end + (3 - mobile_window), total_pages]|min %}
    {% else %}
      {% set mobile_start = [mobile_start - (3 - mobile_window), 1]|max %}
    {% endif %}
  {% endif %}

  {% if page > 1 %}
    {% set prev_args = query_args.copy() %}
    {% set _ = prev_args.update({'page': page - 1}) %}
    <a href="{{ url_for('listings', **prev_args) }}">&laquo; Vorige</a>
  {% endif %}

  {% for p in range(mobile_start, mobile_end + 1) %}
    {% set page_args = query_args.copy() %}
    {% set _ = page_args.update({'page': p}) %}
    {% if p == page %}
      <span style="display:inline-block;margin:0 0.5rem;padding:0.3rem 0.7rem;border:2px solid #4c37c6;border-radius:50%;font-weight:bold;color:#4c37c6;">
        {{ p }}
      </span>
    {% else %}
      <a href="{{ url_for('listings', **page_args) }}"
         style="display:inline-block;margin:0 0.5rem;padding:0.3rem 0.7rem;text-decoration:none;border:1px solid #ccc;border-radius:50%;color:#000;">
        {{ p }}
      </a>
    {% endif %}
  {% endfor %}

  {% if page < total_pages %}
    {% set next_args = query_args.copy() %}
    {% set _ = next_args.update({'page': page + 1}) %}
    <a href="{{ url_for('listings', **next_args) }}">Volgende &raquo;</a>
  {% endif %}
</div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const brandSelect  = document.getElementById('brandSelect');
  const modelSelect  = document.getElementById('modelSelect');

  async function loadModels(brand) {
    modelSelect.disabled = true;
    modelSelect.innerHTML = '<option value="">Model</option>';
    if (!brand) return;

    const res  = await fetch(`/api/models?brand=${encodeURIComponent(brand)}`);
    const list = await res.json();

    modelSelect.insertAdjacentHTML(
      'beforeend',
      list.map(m => `<option value="${m}">${m}</option>`).join('')
    );
    modelSelect.disabled = false;
  }

  brandSelect.addEventListener('change', e => loadModels(e.target.value));

  // if page was loaded with ?brand=… then auto-populate
  if (brandSelect.value) loadModels(brandSelect.value);
});
</script>
{% endblock %}
