{% extends "base.html" %}
{% block title %}Ons Aanbod | Neo Lease{% endblock %}

{% block content %}

<!-- PURPLE HERO (shorter) -->
<!-- Purple Hero (shorter) -->
<section class="listings-hero">
  <div class="container">
    <!-- Heading -->
    <h1 style="text-align:left;">Ons aanbod</h1>

    <!-- Search + Filters Form (stacked) -->
    <form action="{{ url_for('listings') }}" method="get"
          style="max-width:800px; margin-top:1rem;">
      
      <!-- 1) Search row by itself -->
      <div style="margin-bottom:1rem;">
        <input
          type="text"
          name="q"
          placeholder="Bijv. 'GTI' of 'Panoramadak'"
          value="{{ current_q or '' }}"
          style="
            width:100%;
            padding:0.75rem;
            border:1px solid #4c37c6;
            border-radius:4px;
          "
        >
      </div>

      <!-- 2) Filters row (or multiple rows) underneath -->
      <!-- Example: listings.html (or wherever you want the custom dropdown) -->

      <div style="
      display: flex; 
      flex-wrap: wrap;
      gap: 1rem; 
      margin-bottom:1rem;"
      class="filter-box"
      >
      <select name="brand">
        <option value="">Merk</option>
        {% for b in brand_choices %}
          <option value="{{ b }}" {% if b == current_brand %}selected{% endif %}>
            {{ b }}
          </option>
        {% endfor %}
        </select>
                  <!-- DYNAMIC TYPE -->
        <select name="voertuigsoort">
          <option value="">Voertuigsoort</option>
          {% for t in type_choices %}
            <option value="{{ t }}" {% if t == current_voertuigsoort %}selected{% endif %}>
              {{ t }}
            </option>
          {% endfor %}
        </select>
      
        <!-- DYNAMIC FUEL -->
        <select name="brandstof">
          <option value="">Brandstof</option>
          {% for f in fuel_choices %}
            <option value="{{ f }}" {% if f == current_brandstof %}selected{% endif %}>
              {{ f }}
            </option>
          {% endfor %}
        </select>


        <select name="btw_marge">
          <option value="">Btw / Marge</option>
          {% for bm in btw_marge_choices %}
          <option value="{{ bm }}" {% if bm==current_btw_marge %}selected{% endif %}>
            {{ bm }}
          </option>
            {% endfor %}
        </select>

        <select name="monthly" >
          <option value="">Budget&nbsp;(p/m)</option>
          <option value="200-300" {% if current_monthly=='200-300' %}selected{% endif %}>€200 – €300</option>
          <option value="301-400" {% if current_monthly=='301-400' %}selected{% endif %}>€301 – €400</option>
          <option value="401-500" {% if current_monthly=='401-500' %}selected{% endif %}>€401 – €500</option>
          <option value="501-600" {% if current_monthly=='501-600' %}selected{% endif %}>€501 – €600</option>
          <option value="601-700" {% if current_monthly=='601-700' %}selected{% endif %}>€601 – €700</option>
          <option value="700+"    {% if current_monthly=='700+'    %}selected{% endif %}>&gt; €700</option>
        </select>


        <!-- Sort -->
        <select name="sort" >
          <option value="">Sorteren op</option>
          <option value="price_asc" {% if current_sort == 'price_asc' %} selected {% endif %}>Prijs (Laag - Hoog)</option>
          <option value="price_desc" {% if current_sort == 'price_desc' %} selected {% endif %}>Prijs (Hoog - Laag)</option>
        </select>

        <!-- Filter Button -->
        <button type="submit"
                style="
                  background:#4c37c6; 
                  color:#fff; 
                  padding:0.6rem 1.2rem; 
                  border:none;
                  border-radius:4px;
                  font-weight:500;
                "
        >
          Filter
        </button>
        
      </div>
    </form>
  </div>
</section>


<!-- RESULTS COUNT on White Background -->
<div class="container" style="margin-top:1rem;">
  {% if pagination.total %}
    <p style="margin-bottom:1.5rem; font-weight:500;">
      {{ pagination.total }} resultaten gevonden
    </p>
  {% endif %}
</div>


<!-- CAR LISTINGS GRID -->
<section class="container" style="padding-top: 1rem;">
  <div class="car-grid"
       style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
    {% for car in cars %}
      <div class="car-card">
        {# thumbnail with fallback list & spinner #}
    <a href="{{ url_for('car_detail', car_id=car.id) }}"
       class="thumb-wrapper">
    
      {% if car.images and car.images|length > 0 %}
        {% set urls = car.images|map(attribute='image_url')|join(',') %}
        <img class="listing-thumb"
             data-image-urls="{{ urls }}"
             src="{{ car.images[0].image_url }}"
            loading="lazy" 
          width="300" height="180"
            alt="Car Image">
        <div class="thumb-spinner" style="display:none;"></div>
      {% else %}
      <img class="listing-thumb"
           data-image-urls=""
           src="{{ url_for('static', filename='images/fallback.webp') }}"
          loading="lazy" 
        width="300" height="180"
          alt="Geen afbeelding">
      {% endif %}
    </a>


        <h3>
          <a href="{{ url_for('car_detail', car_id=car.id) }}">
            {{ car.title or 'Onbekend' }}
          </a>
        </h3>
        <p style="color:#999; margin-bottom:0.5rem;">
          {{ car.subtitle }}
        </p>
        <p>
          <strong>{{ car.financial_lease_price|euro }}</strong> / {{ car.financial_lease_term }}
        </p>
        <p>
          {{ car.brandstof }} | {{ car.km_stand }} km | {{ car.bouwjaar }}
        </p>
        <p>
          Prijs: {{ car.prijs|euro }}
        </p>
        <a href="{{ url_for('car_detail', car_id=car.id) }}"
           class="btn border"
           style="margin-top:1rem;">
          Meer info
        </a>
      </div>
    {% endfor %}
  </div>

<!-- PAGINATION FOR DESKTOP: show up to 5 page links -->
<div class="d-none d-md-block" style="text-align:center; margin-top:2rem; margin-bottom:3rem;">
  <!-- "Vorige" link -->
  {% if page > 1 %}
    <a href="{{ url_for('listings',
                        page=page-1,
                        brand=current_brand,
                        q=current_q,
                        monthly=current_monthly,
                        sort=current_sort) }}">
      &laquo; Vorige
    </a>
  {% endif %}

  {% for p in range(start_page, end_page + 1) %}
    {% if p == page %}
      <span style="
          display:inline-block;
          margin:0 0.5rem;
          padding:0.3rem 0.7rem;
          border:2px solid #4c37c6;
          border-radius:50%;
          font-weight:bold;
          color:#4c37c6;">
        {{ p }}
      </span>
    {% else %}
      <a href="{{ url_for('listings',
                          page=p,
                          brand=current_brand,
                          q=current_q,
                          monthly=current_monthly,
                          sort=current_sort) }}"
         style="
           display:inline-block;
           margin:0 0.5rem;
           padding:0.3rem 0.7rem;
           text-decoration:none;
           border:1px solid #ccc;
           border-radius:50%;
           color:#000;">
        {{ p }}
      </a>
    {% endif %}
  {% endfor %}

  <!-- "Volgende" link -->
  {% if page < total_pages %}
    <a href="{{ url_for('listings',
                        page=page+1,
                        brand=current_brand,
                        q=current_q,
                        monthly=current_monthly,
                        sort=current_sort) }}">
      Volgende &raquo;
    </a>
  {% endif %}
</div>


<!-- PAGINATION FOR MOBILE: show fewer links (3 max) -->
<div class="d-md-none" style="text-align:center; margin-top:2rem; margin-bottom:3rem;">
  {# We'll do +/-1 around current page, so 3 total. #}
  {% set mobile_start = page - 1 %}
  {% if mobile_start < 1 %}
    {% set mobile_start = 1 %}
  {% endif %}

  {% set mobile_end = page + 1 %}
  {% if mobile_end > total_pages %}
    {% set mobile_end = total_pages %}
  {% endif %}

  {# If the range is still < 3 wide, shift it as needed #}
  {% set mobile_window = mobile_end - mobile_start + 1 %}
  {% if mobile_window < 3 %}
    {% if mobile_start == 1 %}
      {% set mobile_end = [mobile_end + (3 - mobile_window), total_pages]|min %}
    {% else %}
      {% set mobile_start = [mobile_start - (3 - mobile_window), 1]|max %}
    {% endif %}
  {% endif %}

  <!-- Vorige link -->
  {% if page > 1 %}
    <a href="{{ url_for('listings',
                        page=page-1,
                        brand=current_brand,
                        q=current_q,
                        monthly=current_monthly,
                        sort=current_sort) }}">
      &laquo; Vorige
    </a>
  {% endif %}

  {% for p in range(mobile_start, mobile_end + 1) %}
    {% if p == page %}
      <span style="
          display:inline-block;
          margin:0 0.5rem;
          padding:0.3rem 0.7rem;
          border:2px solid #4c37c6;
          border-radius:50%;
          font-weight:bold;
          color:#4c37c6;">
        {{ p }}
      </span>
    {% else %}
      <a href="{{ url_for('listings',
                          page=p,
                          brand=current_brand,
                          q=current_q,
                          monthly=current_monthly,
                          sort=current_sort) }}"
         style="
           display:inline-block;
           margin:0 0.5rem;
           padding:0.3rem 0.7rem;
           text-decoration:none;
           border:1px solid #ccc;
           border-radius:50%;
           color:#000;">
        {{ p }}
      </a>
    {% endif %}
  {% endfor %}

  <!-- Volgende link -->
  {% if page < total_pages %}
    <a href="{{ url_for('listings',
                        page=page+1,
                        brand=current_brand,
                        q=current_q,
                        monthly=current_monthly,
                        sort=current_sort) }}">
      Volgende &raquo;
    </a>
  {% endif %}
</div>
</section>

{% endblock %}
