{% extends "base.html" %}
{% set basePrice = thePrice|int %}

{% block title %}Bereken je maandbedrag | Neo Lease{% endblock %}

{% block content %}
<div class="container my-4" style="max-width:900px;">
  <div class="mb-4">
    <h2 style="color:#4c37c6;">Bereken je maandbedrag</h2>
    {% if car %}
      <h4>{{ car.title }}</h4>
      <p>
        <strong>Catalogusprijs:</strong>
        {{ car.prijs | euro }}
      </p>
    {% endif %}
  </div>

  <div class="row">
    <!-- LEFT: sliders & outputs -->
    <div class="col-md-7">
      <!-- 1) Aanbetaling -->
      <label for="downPaymentSlider" style="font-weight:600;">Aanbetaling</label>
      <input
        type="range"
        class="form-range"
        id="downPaymentSlider"
        min="0"
        max="{{ basePrice }}"
        step="100"
        value="0"
      >
      <p class="mt-1">
        Je aanbetaling is:
        <strong><span id="dpValue">€0,-</span></strong>
      </p>

      <!-- 2) Te financieren bedrag -->
      <p class="text-muted">
        Te financieren bedrag:
        <strong id="loanAmountDisplay">€0,-</strong>
      </p>

      <!-- 3) Slottermijn -->
      <label for="balloonSlider" style="font-weight:600;">Slottermijn</label>
      <input
        type="range"
        class="form-range"
        id="balloonSlider"
        min="0"
        max="{{ (basePrice * 0.15)|int }}"
        step="100"
        value="{{ (basePrice * 0.15)|int }}"
      >
      <p class="mt-1">
        Je slottermijn is:
        <strong><span id="balloonValue">€0,-</span></strong>
      </p>

      <!-- 4) Maandbedragen (zonder slottermijn in de maandlast) -->
      <h5>Maandbedragen (zonder slottermijn in de maandlast):</h5>
      <ul style="list-style:none; padding-left:0;">
        <li>12 maanden: <strong id="m12">€0,-</strong>/mnd</li>
        <li>24 maanden: <strong id="m24">€0,-</strong>/mnd</li>
        <li>36 maanden: <strong id="m36">€0,-</strong>/mnd</li>
        <li>48 maanden: <strong id="m48">€0,-</strong>/mnd</li>
        <li>60 maanden: <strong id="m60">€0,-</strong>/mnd</li>
        <li>72 maanden: <strong id="m72">€0,-</strong>/mnd</li>
      </ul>

      <div class="mt-4">
        <a
          id="applyNowBtn"
          href="{{ url_for('request_quote', car_id=car.id) }}"
          class="btn"
          style="background:#4c37c6; color:#fff;"
        >
          Request a Quote
        </a>
      </div>
    </div>

    <!-- RIGHT: concurrent prijs + afbeelding -->
    <div class="col-md-5">
      {% if car.financial_lease_price and car.financial_lease_term %}
        <div class="border p-3 mb-3">
          <p>Concurrent maandprijs:</p>
          <h4 style="color:green;">
            {{ car.financial_lease_price | euro }}
            / {{ car.financial_lease_term }} mnd
          </h4>
        </div>
      {% endif %}

      {% if car.images and car.images|length > 0 %}
        <img
          src="{{ car.images[0].image_url }}"
          alt="Car image"
          class="img-fluid rounded"
          loading="lazy"
          width="800" height="600"
        >
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const basePrice      = {{ basePrice }};
  const downSlider     = document.getElementById("downPaymentSlider");
  const balloonSlider  = document.getElementById("balloonSlider");
  const dpValueEl      = document.getElementById("dpValue");
  const loanEl         = document.getElementById("loanAmountDisplay");
  const balloonValueEl = document.getElementById("balloonValue");

  const terms = {
    12: document.getElementById("m12"),
    24: document.getElementById("m24"),
    36: document.getElementById("m36"),
    48: document.getElementById("m48"),
    60: document.getElementById("m60"),
    72: document.getElementById("m72"),
  };

  function formatEuro(amount, decimals=0) {
    return Number(amount || 0)
      .toLocaleString("nl-NL", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: decimals
      });
  }

  function recalcAll() {
    // 1) clamp deposit between 0 and basePrice
    const deposit = Math.min(Math.max(Number(downSlider.value), 0), basePrice);
    // 2) financed = basePrice - deposit, not below 0
    const financed = Math.max(basePrice - deposit, 0);

    // 3) update deposit & financed in UI
    dpValueEl.textContent  = formatEuro(deposit);
    loanEl.textContent     = formatEuro(financed);

    // 4) adjust slottermijn slider max to match financed
    balloonSlider.max      = financed;
    // clamp balloon value
    const balloon = Math.min(Number(balloonSlider.value), financed);
    balloonValueEl.textContent = formatEuro(balloon);

    // 5) compute principal = financed - balloon
    const principal = Math.max(financed - balloon, 0);

    // 6) recompute each monthly
    [12,24,36,48,60,72].forEach(term => {
      const monthly = principal / term;
      terms[term].textContent = formatEuro(monthly, 2);
    });
  }

  // re-calc on either slider change
  downSlider.addEventListener("input", recalcAll);
  balloonSlider.addEventListener("input", recalcAll);

  // initial draw
  recalcAll();
});
</script>
{% endblock %}
