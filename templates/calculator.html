{% extends "base.html" %}
{% block title %}Bereken je maandbedrag | Neo Lease{% endblock %}

{% block content %}
<div class="container my-4" style="max-width:900px;">
  <div class="mb-4">
    <h2 style="color:#4c37c6;">Bereken je maandbedrag</h2>
    {% if car %}
      <h4>{{ car.title }}</h4>
      <p>
        <strong>Catalogusprijs:</strong>
        {{ car.prijs | euro }}
      </p>
    {% endif %}
  </div>

  <div class="row">
    <!-- LEFT: sliders & outputs -->
    <div class="col-md-7">
      {# Use thePrice passed from the view #}
      {% set basePrice = thePrice|float %}

      <label for="downPaymentSlider" style="font-weight:600;">Aanbetaling</label>
      <input
        type="range"
        class="form-range"
        id="downPaymentSlider"
        min="0"
        max="{{ basePrice|int }}"
        step="100"
        value="0"
      >
      <p class="mt-1">
        Je aanbetaling is:
        <strong><span id="dpValue">€0,-</span></strong>
      </p>

      <p class="text-muted">
        Te financieren bedrag:
        <strong id="loanAmountDisplay">€0,-</strong>
      </p>

      <p>
        Balloon (15%):
        <strong id="balloonValue">€0,-</strong>
      </p>

      <h5>Maandbedragen (zonder balloon in de maandlast):</h5>
      <ul style="list-style:none; padding-left:0;">
        <li>12 maanden: <strong id="m12">€0,-</strong>/mnd</li>
        <li>24 maanden: <strong id="m24">€0,-</strong>/mnd</li>
        <li>36 maanden: <strong id="m36">€0,-</strong>/mnd</li>
        <li>48 maanden: <strong id="m48">€0,-</strong>/mnd</li>
        <li>60 maanden: <strong id="m60">€0,-</strong>/mnd</li>
        <li>72 maanden: <strong id="m72">€0,-</strong>/mnd</li>
      </ul>

      <div class="mt-4">
        <a
          id="applyNowBtn"
          href="{{ url_for('request_quote', car_id=car.id) }}"
          class="btn"
          style="background:#4c37c6; color:#fff;"
        >
          Request a Quote
        </a>
      </div>
    </div>

    <!-- RIGHT: competitor price + image -->
    <div class="col-md-5">
      {% if car.financial_lease_price and car.financial_lease_term %}
        <div class="border p-3 mb-3">
          <p>Concurrent maandprijs:</p>
          <h4 style="color:green;">
            {{ car.financial_lease_price | euro }}
            / {{ car.financial_lease_term }} mnd
          </h4>
        </div>
      {% endif %}

      {% if car.images and car.images|length > 0 %}
        <img
          src="{{ car.images[0].image_url }}"
          alt="Car image"
          class="img-fluid rounded"
          loading="lazy"
          width="800" height="600"
        >
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // 1) Grab the Jinja-provided base price
  const basePrice = {{ basePrice|int }};

  // 2) DOM refs
  const downSlider = document.getElementById("downPaymentSlider");
  const dpValueEl  = document.getElementById("dpValue");
  const loanEl     = document.getElementById("loanAmountDisplay");
  const balloonEl  = document.getElementById("balloonValue");
  const termEls    = {
    12: document.getElementById("m12"),
    24: document.getElementById("m24"),
    36: document.getElementById("m36"),
    48: document.getElementById("m48"),
    60: document.getElementById("m60"),
    72: document.getElementById("m72"),
  };

  // 3) Euro formatter
  function formatEuro(value, cents = 2) {
    const n = Number(value) || 0;
    return n.toLocaleString("nl-NL", {
      style: "currency",
      currency: "EUR",
      minimumFractionDigits: cents
    });
  }

  // 4) Main recalculation
  function recalcAll() {
    // clamp deposit to [0, basePrice]
    const deposit = Math.min(Number(downSlider.value), basePrice);
    downSlider.max = basePrice;

    // financed never negative
    const financed = Math.max(basePrice - deposit, 0);

    // balloon = 15% of financed
    const balloon = financed * 0.15;

    // update UI
    dpValueEl.textContent     = formatEuro(deposit, 0);
    loanEl.textContent        = formatEuro(financed, 0);
    balloonEl.textContent     = formatEuro(balloon, 0);

    // monthly = (financed – balloon) / term
    const principal = Math.max(financed - balloon, 0);
    [12,24,36,48,60,72].forEach(term => {
      const monthly = principal / term;
      termEls[term].textContent = formatEuro(monthly);
    });
  }

  // 5) Wire up slider
  downSlider.addEventListener("input", recalcAll);

  // 6) Initial
  recalcAll();
});
</script>
{% endblock %}
