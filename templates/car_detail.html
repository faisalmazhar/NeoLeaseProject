{# ───────────────────────────────────────────────────────── templates/car_detail.html ── #}
{% extends "base.html" %}
{% block title %}{{ car.title or "Auto Detail" }} | Neo Lease{% endblock %}

{% macro clean(v) %}
  {%- if v and v|string|lower not in ['nan', 'none'] -%}{{ v }}{%- else -%}N/A{%- endif -%}
{% endmacro %}

{% block content %}
<section class="car-detail-page">
  <div class="container">
    <div class="car-detail-wrapper">

      <!-- ─── LEFT COLUMN (images + data) ──────────────────────────────── -->
      <div class="left-column">

        <div class="car-heading">
          <h1 class="car-title">
            {{ car.title }} <button class="favorite-btn" title="Toevoegen aan favorieten"></button>
          </h1>
          <p class="car-subtitle">{{ car.subtitle }}</p>
        </div>

        {# build csv for lazy-loading thumbnails #}
        {% if car.images %}
          {% set all_urls = car.images|map(attribute='image_url')|join(',') %}
        {% else %}
          {% set all_urls = '' %}
        {% endif %}

        <div class="carousel-wrapper">
          <div class="carousel-container">
            <button class="carousel-arrow arrow-left">&#10094;</button>

            <div class="carousel-single-image" data-image-urls="{{ all_urls }}">
              <img id="carousel-big-image"
                 src="{{ car.images[0].image_url if all_urls else url_for('static', filename='images/fallback.webp') }}"
                  loading="lazy"   
                  width="800" height="600"

                  alt="Car image">
              
              <div id="img-spinner" class="spinner" style="display:none;"></div>
            </div>

            <button class="carousel-arrow arrow-right">&#10095;</button>
          </div>

          <!-- ─── mock calculator ───────────────────────────── -->
          <div class="car-right">
            <div class="calc-box">
              <h3 class="calc-title">Jouw lease-calculator</h3>

              {% if car.financial_lease_price and car.financial_lease_term %}
                <p style="font-size:1.1rem;margin-bottom:1rem;"><strong>{{ car.financial_lease_price }}</strong> per {{ car.financial_lease_term }} maanden</p>
              {% else %}
                <p><em>Geen maandprijs beschikbaar</em></p>
              {% endif %}

              <p class="calc-desc">Stel hier je maandbedrag af voor financial lease,
                 <strong>kies looptijd, aanbetaling&nbsp;&amp;&nbsp;slottermijn</strong>.</p>

              <p style="margin-top:1rem;">
                <a href="{{ url_for('calculator', car_id=car.id) }}" class="btn purple">Open Calculator</a>
              </p>

              <hr>
              <p>Wil je deze auto <strong>favoriet</strong> maken of <strong>opslaan</strong> voor later?</p>
              <button class="btn border favorite-btn"
                      data-car-id="{{ car.id }}"
                      data-title="{{ car.title }}"
                      data-image="{{ car.images[0].image_url if car.images }}"
                      data-monthly="{{ car.financial_lease_price|euro or '' }}">
                <i class="fa-regular fa-heart" style="color:#fff;"></i> Favoriet toevoegen
              </button>
            </div>
          </div><!-- /.car-right -->
        </div><!-- /.carousel-wrapper -->

        <!-- ╔═════════════  OVER DEZE AUTO  ══════════════╗ -->
        <h2 class="car-title">Over deze auto</h2>

        {# decide brand icon #}
        {% set brand_icons = {
          'audi':'https://img.icons8.com/ios/50/audi.png','bmw':'/static/images/bmw1.svg','kia':'https://img.icons8.com/color/48/kia.png',
          'volkswagen':'https://img.icons8.com/ios/50/volkswagen.png','volvo':'https://img.icons8.com/ios/50/volvo.png'
        } %}
        {% set brand_icon = brand_icons.get(car.merk|lower, "https://img.icons8.com/ios-filled/50/car.png") %}

        {# ─── primary specs (always visible) ─── #}
        {% set primary_specs = [
          ('Merk',        clean(car.merk),      brand_icon),
          ('Model',       clean(car.model),     'https://img.icons8.com/ios-filled/50/car.png'),
          ('Bouwjaar',    clean(car.bouwjaar),  url_for('static', filename='images/calendar.png')),
          ('Km stand',    clean(car.km_stand~' km' if car.km_stand else None), url_for('static', filename='images/speedometer.png')),
          ('Transmissie', clean(car.transmissie), url_for('static', filename='images/manual-transmission.png')),
          ('Brandstof',   clean(car.brandstof), url_for('static', filename='images/fuel.png')),
          ('Btw/marge',   clean(car.btw_marge), url_for('static', filename='images/vat.png')),
          ('Prijs',       clean(car.prijs),     url_for('static', filename='images/get-money.png'))
        ] %}


        {# ─── extra specs (toggle) ─── #}
        {% set extra_specs = [
          ('Adres',              clean(car.address)),
          ('Voertuigsoort',      clean(car.voertuigsoort)),
          ('Gebruikt/nieuw',     clean(car.gebruikt_nieuw)),
          ('Incl. btw',          clean(car.inclusief_btw)),
          ('Incl. bpm',          clean(car.inclusief_bpm)),
          ('Type',               clean(car.type)),
          ('Inrichting',         clean(car.inrichting)),
          ('Versnellingen',      clean(car.aantal_versnellingen)),
          ('Carrosserie',        clean(car.carrosserie)),
          ('Bekleding',          clean(car.bekleding)),
          ('Deuren',             clean(car.aantal_deuren)),
          ('Zitplaatsen',        clean(car.aantal_zitplaatsen)),
          ('Kleur',              clean(car.kleur_basis)),
          ('Bovag',              clean(car.bovag)),
          ('NAP',                clean(car.nap)),
          ('Vermogen motor',     clean(car.vermogen_motor)),
          ('Cilinderinhoud',     clean(car.cilinderinhoud)),
          ('Aantal cilinders',   clean(car.aantal_cilinders)),
          ('Wielbasis',          clean(car.wielbasis)),
          ('Gewicht',            clean(car.gewicht)),
          ('Topsnelheid',        clean(car.topsnelheid)),
          ('Energielabel',       clean(car.energielabel)),
          ('Gem. verbruik',      clean(car.gemiddeld_verbruik)),
          ('Tankinhoud',         clean(car.tankinhoud))
        ] %}
        <!-- main wrapper -->
        <div id="spec-wrapper">

          <!-- SECTION 1 ─ primary grid -->
          <div id="spec-primary" class="spec-grid">
            {% for label,val,icon in primary_specs %}
              <div class="spec-row">
                <img src="{{ icon }}" class="spec-bullet" alt="">
                <span class="spec-label">{{ label }}</span>
                <span class="spec-value">{{ val }}</span>
              </div>
            {% endfor %}
          </div>

          <!-- SECTION 2 ─ hidden extras -->
          <div id="spec-extra" class="spec-grid d-none">
            {% for label,val in extra_specs %}
              <div class="spec-row">
                <img src="{{ url_for('static', filename='images/arrow.webp') }}" class="spec-bullet" alt="">
                <span class="spec-label">{{ label }}</span>
                <span class="spec-value">{{ val }}</span>
              </div>
            {% endfor %}
          </div>
        </div>

        <button id="toggle-specs" class="toggle-btn">
          Toon meer <img src="{{ url_for('static', filename='images/arrow.webp') }}" alt="">
        </button>

        <hr class="section-divider">

        {# ----------  OPTIES & ACCESSOIRES  ---------- #}
        {% set opts = (car.opties_accessoires or '').split(',')|map('trim')|reject('equalto','')|list %}
        {% if opts %}
          <h2>Opties &amp; Accessoires</h2>

          <ul id="opts-primary" class="opties-list">
            {% for o in opts[:5] %}<li>- {{ o }}</li>{% endfor %}
          </ul>

          {% if opts|length > 5 %}
            <ul id="opts-extra" class="opties-list d-none">
              {% for o in opts[5:] %}<li>- {{ o }}</li>{% endfor %}
            </ul>

          <button id="toggle-opts" class="toggle-btn">
            Toon meer <img src="{{ url_for('static', filename='images/arrow.webp') }}" alt="">
          </button>

          {% endif %}
        {% endif %}

        <!-- small Google-map -->
        <div class="map-section" style="margin-top:2rem;">
          {% if car.address %}
            <h3>Locatie:</h3>
            <iframe width="100%" height="250"
                    style="border:0" loading="lazy" allowfullscreen
                    src="https://www.google.com/maps?q={{ car.address|urlencode }}&output=embed"></iframe>
            <p style="color:#555;">{{ car.address }}</p>
          {% else %}
            <p><em>Geen adres beschikbaar</em></p>
          {% endif %}
        </div>

      </div><!-- /.left-column -->
    </div><!-- /.car-detail-wrapper -->
  </div><!-- /.container -->
</section>

{# ─────────────────── FEATURED CAR MARQUEE (unchanged) ─────────────────── #}
{% if random_cars %}
  <div class="container">
    <section class="featured-cars-marquee-section" style="padding:2rem 1rem;">
      <h2 style="text-align:center;color:#4c37c6;margin-bottom:1rem;">Andere interessante deals</h2>
      <p style="text-align:center;max-width:700px;margin:0 auto 2rem;font-size:.95rem;">Een selectie van auto’s uit onze database&nbsp;&mdash; scroll voor meer!</p>
      <div class="featured-cars-marquee">
        {% for c in random_cars %}
          <div class="featured-car-card">
            <a href="{{ url_for('car_detail',car_id=c.id) }}" style="text-decoration:none;color:inherit;">
              {% if c.images %}<img src="{{ c.images[0].image_url }}"      
                                 loading="lazy"
                                 width="250"
                                 height="180"
                                 alt="{{ c.title }}">{% endif %}
              <h3 style="color:#4c37c6;font-size:1rem;margin-top:.5rem;">{{ c.title }}</h3>
              <p style="font-size:.9rem;">{{ c.financial_lease_price|euro }} / {{ c.financial_lease_term }}</p>
            </a>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
{% endif %}

<!-- ─── tiny JS; works even if you have jQuery disabled ─── -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* extra specs */
  const btnSpecs   = document.getElementById('toggle-specs');
  const extraSpecs = document.getElementById('spec-extra');
  if (btnSpecs && extraSpecs) {
    btnSpecs.addEventListener('click', () => {
      extraSpecs.classList.toggle('d-none');
      const open = !extraSpecs.classList.contains('d-none');
      btnSpecs.firstChild.textContent = open ? 'Toon minder ' : 'Toon meer ';
      btnSpecs.querySelector('img').style.transform = open ? 'rotate(90deg)' : 'rotate(0deg)';
    });
  }

  /* extra options */
  const btnOpts = document.getElementById('toggle-opts');
  const extraOpts = document.getElementById('opts-extra');
  if (btnOpts && extraOpts) {
    btnOpts.addEventListener('click', () => {
      extraOpts.classList.toggle('d-none');
      const open = !extraOpts.classList.contains('d-none');
      btnOpts.firstChild.textContent = open ? 'Toon minder ' : 'Toon meer ';
      btnOpts.querySelector('img').style.transform = open ? 'rotate(90deg)' : 'rotate(0deg)';
    });
  }

});
</script>

<style>
  .spec-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem 2rem;margin-bottom:1.5rem;}
  .spec-bullet{width:30px;height:auto;margin-right:.4rem}
  .spec-row{display:flex;align-items:center;font-size:.95rem}
  .spec-label{font-weight:600;margin-right:.3rem}
  .d-none{display:none!important}
  .toggle-btn{border:none;background:none;color:#4c37c6;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:.25rem}
  .toggle-btn img{transition:transform .25s}
</style>
{% endblock %}
